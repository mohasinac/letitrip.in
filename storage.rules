rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             request.auth.token.role == 'admin';
    }
    
    function isModerator() {
      return isAuthenticated() && 
             (request.auth.token.role == 'moderator' || request.auth.token.role == 'admin');
    }
    
    function isSeller() {
      return isAuthenticated() && 
             (request.auth.token.role == 'seller' || request.auth.token.role == 'admin');
    }
    
    function isImage(contentType) {
      return contentType.matches('image/.*');
    }
    
    function isVideo(contentType) {
      return contentType.matches('video/.*');
    }
    
    function isDocument(contentType) {
      return contentType.matches('application/pdf') ||
             contentType.matches('application/msword') ||
             contentType.matches('application/vnd.openxmlformats-officedocument.wordprocessingml.document') ||
             contentType.matches('application/vnd.ms-excel') ||
             contentType.matches('application/vnd.openxmlformats-officedocument.spreadsheetml.sheet') ||
             contentType.matches('text/.*');
    }
    
    function isAllowedFileType(contentType) {
      return isImage(contentType) || isVideo(contentType) || isDocument(contentType);
    }
    
    // User avatars - users can upload their own avatars
    match /avatars/{userId}/{fileName} {
      allow read: if true;
      allow write: if isAuthenticated() 
        && request.auth.uid == userId
        && isImage(request.resource.contentType)
        && request.resource.size < 5 * 1024 * 1024; // 5MB limit
      allow delete: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
    }
    
    // Category images - admin/moderator only
    match /categories/{categoryId}/{fileName} {
      allow read: if true;
      allow write: if isModerator()
        && isImage(request.resource.contentType)
        && request.resource.size < 5 * 1024 * 1024; // 5MB limit
      allow delete: if isModerator();
    }
    
    // Hero slides - admin only
    match /hero-slides/{slideId}/{fileName} {
      allow read: if true;
      allow write: if isAdmin()
        && isImage(request.resource.contentType)
        && request.resource.size < 10 * 1024 * 1024; // 10MB limit
      allow delete: if isAdmin();
    }
    
    // Public read paths (CDN-backed)
    match /shop-logos/{allPaths=**} {
      allow read: if true;
      allow write: if isSeller() && isImage(request.resource.contentType); // Sellers can upload image logos
    }
    
    match /shop-banners/{allPaths=**} {
      allow read: if true;
      allow write: if isSeller() && isImage(request.resource.contentType); // Sellers can upload image banners
    }
    
    match /product-images/{allPaths=**} {
      allow read: if true;
      allow write: if isSeller() && isImage(request.resource.contentType); // Sellers can upload product images
    }
    
    // Product videos (for video demos, unboxing, etc.)
    match /product-videos/{allPaths=**} {
      allow read: if true;
      allow write: if isSeller() && isVideo(request.resource.contentType) && request.resource.size < 100 * 1024 * 1024; // 100MB limit
    }
    
    // Static assets (payment logos, icons, images, documents, videos)
    match /static-assets/{type}/{category}/{fileName} {
      allow read: if true; // Public read for CDN
      allow write: if isAdmin() && isAllowedFileType(request.resource.contentType) && request.resource.size < 50 * 1024 * 1024; // 50MB limit
      allow delete: if isAdmin();
    }
    
    // Blog images and videos
    match /blog-media/{postId}/{fileName} {
      allow read: if true;
      allow write: if isAdmin() && (isImage(request.resource.contentType) || isVideo(request.resource.contentType)) && request.resource.size < 50 * 1024 * 1024;
      allow delete: if isAdmin();
    }
    
    // User documents (invoices, receipts, etc.)
    match /user-documents/{userId}/{fileName} {
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      allow write: if isAuthenticated() && request.auth.uid == userId && isDocument(request.resource.contentType) && request.resource.size < 10 * 1024 * 1024; // 10MB limit
      allow delete: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
    }
    
    // Deny everything else from direct client access
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
