<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beyblade Game Server - Test Client</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
        }
        h1 {
            color: #00d4ff;
            text-align: center;
        }
        .section {
            background: #16213e;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #00d4ff;
        }
        button {
            background: #00d4ff;
            color: #1a1a2e;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
        }
        button:hover {
            background: #00a8cc;
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        .log {
            background: #0f3460;
            padding: 15px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry {
            padding: 3px 0;
            border-bottom: 1px solid #1a1a2e;
        }
        .success { color: #4ecca3; }
        .error { color: #ff6b6b; }
        .info { color: #95e1d3; }
        .state {
            background: #0f3460;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        input, select {
            background: #0f3460;
            border: 1px solid #00d4ff;
            color: #eee;
            padding: 8px;
            border-radius: 5px;
            margin: 5px;
            width: 200px;
        }
        label {
            display: inline-block;
            width: 120px;
            color: #95e1d3;
        }
    </style>
</head>
<body>
    <h1>üéÆ Beyblade Game Server Test Client</h1>
    
    <div class="section">
        <h2>Connection</h2>
        <div>
            <label>Server URL:</label>
            <input type="text" id="serverUrl" value="ws://localhost:2567" />
        </div>
        <div>
            <label>User ID:</label>
            <input type="text" id="userId" value="test-user-123" />
        </div>
        <div>
            <label>Username:</label>
            <input type="text" id="username" value="TestPlayer" />
        </div>
        <div>
            <label>Beyblade ID:</label>
            <input type="text" id="beybladeId" value="beyblade_1" placeholder="Use any ID - will use defaults if not found" />
        </div>
        <div>
            <label>Arena ID:</label>
            <input type="text" id="arenaId" value="arena_1" placeholder="Use any ID - will use defaults if not found" />
        </div>
        <br>
        <button id="connectBtn" onclick="connectToServer()">Connect to Tryout Room</button>
        <button id="disconnectBtn" onclick="disconnect()" disabled>Disconnect</button>
    </div>

    <div class="section">
        <h2>Controls</h2>
        <button onclick="sendInput('up')">‚Üë Up</button>
        <button onclick="sendInput('down')">‚Üì Down</button>
        <button onclick="sendInput('left')">‚Üê Left</button>
        <button onclick="sendInput('right')">‚Üí Right</button>
        <br>
        <button onclick="sendAction('charge')">‚ö° Charge</button>
        <button onclick="sendAction('dash')">üöÄ Dash</button>
        <button onclick="sendAction('special')">‚ú® Special</button>
    </div>

    <div class="section">
        <h2>Game State</h2>
        <div class="state" id="gameState">Not connected</div>
    </div>

    <div class="section">
        <h2>Console Log</h2>
        <div class="log" id="log"></div>
    </div>

    <script src="https://unpkg.com/colyseus.js@0.15.0/dist/colyseus.js"></script>
    <script>
        let client;
        let room;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function connectToServer() {
            try {
                const serverUrl = document.getElementById('serverUrl').value;
                const userId = document.getElementById('userId').value;
                const username = document.getElementById('username').value;
                const beybladeId = document.getElementById('beybladeId').value;
                const arenaId = document.getElementById('arenaId').value;

                log(`Connecting to ${serverUrl}...`, 'info');
                
                // Check if Colyseus is loaded
                if (typeof window.Colyseus === 'undefined') {
                    throw new Error('Colyseus library not loaded. Please refresh the page.');
                }
                
                client = new window.Colyseus.Client(serverUrl);

                room = await client.joinOrCreate("tryout_room", {
                    userId,
                    username,
                    beybladeId,
                    arenaId
                });

                log(`‚úÖ Connected to room ${room.id}`, 'success');

                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;

                // Listen for state changes
                room.onStateChange((state) => {
                    updateGameState(state);
                });

                // Listen for messages
                room.onMessage("ring-out", (data) => {
                    log(`üö® Ring out! Player ${data.playerId}`, 'error');
                });

                room.onMessage("special-move", (data) => {
                    log(`‚ú® Special move by ${data.playerId}`, 'info');
                });

                room.onError((code, message) => {
                    log(`‚ùå Error: ${message}`, 'error');
                });

                room.onLeave((code) => {
                    log(`Disconnected (code: ${code})`, 'info');
                    document.getElementById('connectBtn').disabled = false;
                    document.getElementById('disconnectBtn').disabled = true;
                });

            } catch (e) {
                log(`‚ùå Connection failed: ${e.message}`, 'error');
            }
        }

        function disconnect() {
            if (room) {
                room.leave();
                log('Disconnected from room', 'info');
            }
        }

        function updateGameState(state) {
            const stateDiv = document.getElementById('gameState');
            let html = `<strong>Status:</strong> ${state.status}<br>`;
            html += `<strong>Mode:</strong> ${state.mode}<br>`;
            html += `<strong>Timer:</strong> ${Math.floor(state.timer)}s<br>`;
            html += `<strong>Arena:</strong> ${state.arena.name} (${state.arena.width}x${state.arena.height})<br>`;
            html += `<br><strong>Beyblades:</strong><br>`;

            state.beyblades.forEach((beyblade, key) => {
                html += `<div style="margin-left: 20px; padding: 5px; background: #1a1a2e; border-radius: 3px; margin-top: 5px;">`;
                html += `<strong>${beyblade.username}</strong> (${beyblade.beybladeId})<br>`;
                html += `Position: (${beyblade.x.toFixed(1)}, ${beyblade.y.toFixed(1)})<br>`;
                html += `Velocity: (${beyblade.velocityX.toFixed(2)}, ${beyblade.velocityY.toFixed(2)})<br>`;
                html += `Spin: ${beyblade.angularVelocity.toFixed(2)} rad/s<br>`;
                html += `Health: ${beyblade.health.toFixed(0)}% | Stamina: ${beyblade.stamina.toFixed(0)}%<br>`;
                html += `Active: ${beyblade.isActive ? '‚úÖ' : '‚ùå'} | Ring Out: ${beyblade.isRingOut ? '‚úÖ' : '‚ùå'}`;
                html += `</div>`;
            });

            stateDiv.innerHTML = html;
        }

        function sendInput(direction) {
            if (!room) {
                log('Not connected to a room', 'error');
                return;
            }

            const directions = {
                'up': { x: 0, y: -1 },
                'down': { x: 0, y: 1 },
                'left': { x: -1, y: 0 },
                'right': { x: 1, y: 0 }
            };

            room.send("input", {
                direction: directions[direction],
                timestamp: Date.now()
            });

            log(`Sent input: ${direction}`, 'info');
        }

        function sendAction(actionType) {
            if (!room) {
                log('Not connected to a room', 'error');
                return;
            }

            room.send("action", {
                type: actionType
            });

            log(`Sent action: ${actionType}`, 'success');
        }

        // Keyboard controls
        document.addEventListener('keydown', (e) => {
            if (!room) return;

            switch(e.key) {
                case 'ArrowUp':
                case 'w':
                case 'W':
                    sendInput('up');
                    break;
                case 'ArrowDown':
                case 's':
                case 'S':
                    sendInput('down');
                    break;
                case 'ArrowLeft':
                case 'a':
                case 'A':
                    sendInput('left');
                    break;
                case 'ArrowRight':
                case 'd':
                case 'D':
                    sendInput('right');
                    break;
                case ' ':
                    sendAction('charge');
                    break;
                case 'Shift':
                    sendAction('dash');
                    break;
                case 'e':
                case 'E':
                    sendAction('special');
                    break;
            }
        });

        log('Test client loaded. Use arrow keys or WASD to move, Space to charge, Shift to dash, E for special.', 'success');
    </script>
</body>
</html>
