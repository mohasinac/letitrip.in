# Addresses Collection Schema

## Collection Structure

**Collection Name**: `addresses`

**Purpose**: Store user delivery/shipping addresses for e-commerce orders

**Location**: Firebase Firestore

---

## Document Structure

```typescript
interface AddressDocument {
  // Document ID (auto-generated by Firebase)
  id: string;

  // Foreign key to users collection
  userId: string;

  // Contact Information
  fullName: string;
  phoneNumber: string;

  // Address Details
  addressLine1: string; // House No., Building Name
  addressLine2: string; // Road Name, Area, Colony
  landmark: string; // Optional: Near Bus Stop, Behind Mall
  city: string;
  state: string; // Indian states initially
  pincode: string; // 6 digits for India

  // Address Classification
  addressType: "home" | "work" | "other";
  isDefault: boolean; // Only one per user should be true

  // Timestamps
  createdAt: Timestamp;
  updatedAt: Timestamp;
}
```

---

## Indexed Fields

Configure these indices in Firebase Console (`Firestore Database → Indexes`):

### Composite Indices

1. **User Addresses Query** (for listing user's addresses)
   - Collection: `addresses`
   - Fields:
     - `userId` (Ascending)
     - `createdAt` (Descending)

2. **Default Address Query** (for finding user's default address)
   - Collection: `addresses`
   - Fields:
     - `userId` (Ascending)
     - `isDefault` (Descending)

### Single Field Indices (Auto-created)

- `userId` - For querying addresses by user
- `isDefault` - For filtering default addresses

---

## Relationships

```
users (1) ----< (N) addresses

Foreign Key Pattern:
addresses/{addressId}.userId → users/{userId}.uid
```

**Cascade Behavior**:

- When user is deleted: Delete all associated addresses
- Use batch write to ensure atomic deletion

---

## Security Rules

```javascript
// firestore.rules
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /addresses/{addressId} {
      // Users can only read their own addresses
      allow read: if request.auth != null
                  && resource.data.userId == request.auth.uid;

      // Users can create addresses for themselves
      allow create: if request.auth != null
                    && request.resource.data.userId == request.auth.uid
                    && isValidAddress(request.resource.data);

      // Users can update their own addresses
      allow update: if request.auth != null
                    && resource.data.userId == request.auth.uid
                    && request.resource.data.userId == resource.data.userId
                    && isValidAddress(request.resource.data);

      // Users can delete their own addresses
      allow delete: if request.auth != null
                    && resource.data.userId == request.auth.uid;
    }

    // Helper function to validate address data
    function isValidAddress(address) {
      return address.keys().hasAll([
        'userId', 'fullName', 'phoneNumber', 'addressLine1',
        'city', 'state', 'pincode', 'addressType', 'isDefault'
      ])
      && address.fullName is string && address.fullName.size() > 0
      && address.phoneNumber is string && address.phoneNumber.matches('^[6-9][0-9]{9}$')
      && address.pincode is string && address.pincode.matches('^[0-9]{6}$')
      && address.addressType in ['home', 'work', 'other']
      && address.isDefault is bool;
    }
  }
}
```

---

## Validation Rules

### Client-Side Validation

**Full Name**:

- Required
- Non-empty string

**Phone Number**:

- Required
- Format: 10 digits starting with 6-9 (Indian mobile)
- Pattern: `/^[6-9]\d{9}$/`

**Pincode**:

- Required
- Format: 6 digits
- Pattern: `/^\d{6}$/`

**Address Line 1**:

- Required
- Non-empty string

**Address Line 2**:

- Optional
- String

**Landmark**:

- Optional
- String

**City**:

- Required
- Non-empty string

**State**:

- Required
- One of: Indian states list (see INDIAN_STATES constant)

**Address Type**:

- Required
- One of: `'home' | 'work' | 'other'`

**Is Default**:

- Boolean
- Only one address per user should have `isDefault: true`

---

## Default Address Logic

### Setting Default Address

When a user sets an address as default:

1. Find all addresses where `userId == currentUserId` AND `isDefault == true`
2. Set `isDefault = false` for all found addresses
3. Set `isDefault = true` for the selected address

**Implementation**:

```typescript
// Batch write for atomic operation
const batch = writeBatch(db);

// Unset all other defaults
const snapshot = await getDocs(
  query(
    collection(db, "addresses"),
    where("userId", "==", userId),
    where("isDefault", "==", true),
  ),
);

snapshot.docs.forEach((doc) => {
  if (doc.id !== addressId) {
    batch.update(doc.ref, { isDefault: false });
  }
});

// Set new default
batch.update(doc(db, "addresses", addressId), {
  isDefault: true,
  updatedAt: serverTimestamp(),
});

await batch.commit();
```

---

## Query Patterns

### Get all user addresses

```typescript
const q = query(
  collection(db, "addresses"),
  where("userId", "==", userId),
  orderBy("createdAt", "desc"),
);
const snapshot = await getDocs(q);
```

### Get default address

```typescript
const q = query(
  collection(db, "addresses"),
  where("userId", "==", userId),
  where("isDefault", "==", true),
  limit(1),
);
const snapshot = await getDocs(q);
```

### Get single address

```typescript
const docRef = doc(db, "addresses", addressId);
const docSnap = await getDoc(docRef);
```

---

## Future Enhancements

### International Support

When adding international address support:

1. Add `country` field:

   ```typescript
   country: string; // ISO country code
   ```

2. Make `state` optional for countries without states

3. Adjust pincode validation:
   - India: 6 digits
   - USA: 5 or 9 digits (ZIP code)
   - UK: Variable length postcode
   - etc.

4. Add country-specific validation rules

### Seller/Shop Addresses

For sellers who need multiple business addresses:

1. Add `addressOwnerType` field:

   ```typescript
   addressOwnerType: "user" | "shop";
   ```

2. Add optional `shopId` field:

   ```typescript
   shopId?: string; // Reference to shops collection
   ```

3. Update security rules to handle shop owner access

---

## Migration Checklist

Before deploying to production:

- [ ] Create composite indices in Firebase Console
- [ ] Deploy Firestore security rules
- [ ] Test address creation with validation
- [ ] Test default address toggle logic
- [ ] Test batch deletion on user deletion
- [ ] Test query performance with indices
- [ ] Add monitoring for failed writes
- [ ] Set up backup strategy for addresses collection

---

## Related Files

**Hooks**:

- `src/hooks/useAddresses.ts` - Address CRUD hooks

**Pages**:

- `src/app/user/addresses/page.tsx` - Address list
- `src/app/user/addresses/add/page.tsx` - Add address form
- `src/app/user/addresses/edit/[id]/page.tsx` - Edit address form

**Components**:

- `src/components/modals/ConfirmDeleteModal.tsx` - Delete confirmation

**Types**:

- Defined in `src/hooks/useAddresses.ts`

---

## Notes

- This schema supports **Indian addresses initially**
- **Extensible** for international support
- **Reusable** for seller/shop addresses with minor modifications
- **Follows** project compliance standards (Repository pattern, type utilities, query helpers)
